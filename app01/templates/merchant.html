<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å®¶åå°</title>
    <style>
    /* ========== æºç¨‹é£æ ¼é…è‰²æ–¹æ¡ˆ ========== */
    :root {
        --ctrip-blue: #1A2F6B;         /* æºç¨‹å“ç‰Œè“ */
        --ctrip-orange: #4A90E2;
        {#FF6A00  æºç¨‹å“ç‰Œæ©™#}
        --ctrip-light-blue: #4A90E2;   /* è¾…åŠ©è“è‰² */
        --success-green: #4A90E2;
        --danger-red: #E53935;         /* è­¦ç¤ºçº¢ */
        --bg-light: #F5F7FA;           /* æµ…ç°èƒŒæ™¯ */
        --text-dark: #2D3436;          /* æ·±ç°æ–‡å­— */
        --text-light: #FFFFFF;         /* çº¯ç™½æ–‡å­— */
        --border-color: #DFE3E8;       /* è¾¹æ¡†é¢œè‰² */
        --radius-md: 4px;
        --radius-lg: 8px;
        --shadow-sm: 0 2px 8px rgba(28, 36, 56, 0.08);
        --shadow-md: 0 4px 12px rgba(28, 36, 56, 0.12);
        --shadow-lg: 0 8px 24px rgba(28, 36, 56, 0.16);
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== åŸºç¡€é‡ç½® ========== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'å¾®è½¯é›…é»‘', sans-serif;
    }

    body {
        background: var(--bg-light);
        color: var(--text-dark);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
    }

    /* ========== ä¾§è¾¹å¯¼èˆªæ  ========== */
    .sidebar {
        width: 240px;
        background: var(--ctrip-blue);
        position: fixed;
        height: 100%;
        box-shadow: var(--shadow-md);
        z-index: 1000;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .logo {
        color: var(--text-light);
        font-size: 20px;
        font-weight: 500;
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    .nav-menu {
        padding: 16px;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 12px;
        color: rgba(255,255,255,0.9);
        padding: 12px 16px;
        margin: 8px 0;
        border-radius: var(--radius-md);
        transition: var(--transition);
        text-decoration: none;
        font-size: 14px;
    }

    .nav-link:hover {
        background: rgba(255,255,255,0.15);
        transform: translateX(4px);
    }

    /* ========== ä¸»å†…å®¹åŒº ========== */
    .main-content {
        margin-left: 240px;
        padding: 88px 32px 32px;
        min-height: 100vh;
    }

    .top-nav {
        position: fixed;
        top: 0;
        right: 0;
        left: 240px;
        height: 64px;
        background: var(--text-light);
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 0 24px;
        z-index: 999;
    }

    /* ========== æŒ‰é’®æ ·å¼ ========== */
    .welcome-btn{
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
        background: #71a5e6;
        color: var(--text-light);
        font-size: 14px;
        text-decoration: none !important;
    }


    .user-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
        background: var(--ctrip-orange);
        color: var(--text-light);
        font-size: 14px;
        text-decoration: none !important;
    }

    .user-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .user-btn.danger {
        background: var(--danger-red);
    }

    .add-dish-btn {
        background: var(--success-green);
    }

    /* ========== åˆ†ç±»è¿‡æ»¤æŒ‰é’® ========== */
    .filter-group {
        display: flex;
        gap: 12px;
        margin: 24px 0;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 6px 16px;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        background: var(--text-light);
        color: var(--text-dark);
        cursor: pointer;
        transition: var(--transition);
        font-size: 14px;
    }

    .filter-btn:hover {
        border-color: var(--ctrip-orange);
        color: var(--ctrip-orange);
    }

    .filter-btn.active {
        background: var(--ctrip-orange);
        color: var(--text-light);
        border-color: var(--ctrip-orange);
    }

    /* ========== å¡ç‰‡è®¾è®¡ ========== */
    .dish-card {
        background: var(--text-light);
        border-radius: var(--radius-lg);
        padding: 16px;
        margin: 16px 0;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
    }

    .dish-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .dish-info h3 {
        color: var(--ctrip-blue);
        font-size: 16px;
        margin-bottom: 4px;
        font-weight: 600;
    }

    .dish-info p {
        color: #666;
        font-size: 13px;
    }

    /* ========== è¡¨å•æ ·å¼ ========== */
    .dish-form {
        background: var(--text-light);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-sm);
        margin-bottom: 24px;
        border: 1px solid var(--border-color);
    }

    .form-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    input, select, textarea {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        transition: var(--transition);
        font-size: 14px;
        background: var(--text-light);
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--ctrip-orange);
        box-shadow: 0 0 0 3px rgba(255, 106, 0, 0.15);
    }

    /* ========== åŠ è½½åŠ¨ç”» ========== */
    .loading-mask {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.9);
        display: none;
        place-items: center;
        z-index: 2000;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--ctrip-orange);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ========== é”™è¯¯æç¤º ========== */
    .error-msg {
        padding: 12px 16px;
        background: #FFF5F5;
        color: var(--danger-red);
        border-radius: var(--radius-md);
        margin-top: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #FED7D7;
        font-size: 14px;
    }

    /* ========== ç¼–è¾‘è¡¨å• ========== */
    .edit-form-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        place-items: center;
        z-index: 2000;
    }

    .edit-form {
        background: var(--text-light);
        padding: 24px;
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
    }

    /* ========== å“åº”å¼è®¾è®¡ ========== */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
            width: 280px;
        }

        .main-content {
            margin-left: 0;
            padding: 88px 16px 16px;
        }

        .top-nav {
            left: 0;
            padding: 0 16px;
        }

        .menu-toggle {
            display: block;
        }

        .filter-group {
            gap: 8px;
        }
    }
</style>
</head>
<body>
    <!-- ç§»åŠ¨ç«¯èœå•å¼€å…³ï¼ˆä¸éª‘æ‰‹ç«¯ç›¸åŒç»“æ„ï¼‰ -->
    <button class="menu-toggle" aria-label="åˆ‡æ¢èœå•">â˜°</button>

    <div class="container">
        <!-- å·¦ä¾§å¯¼èˆªæ ï¼ˆä¿æŒä¸éª‘æ‰‹ç«¯ç›¸åŒDOMç»“æ„ï¼‰ -->
        <nav class="sidebar" aria-label="ä¸»èœå•">
            <div class="logo">å•†å®¶ä¸­å¿ƒ</div>
            <ul class="nav-menu">
                <!-- ä½¿ç”¨data-typeå±æ€§ä¿æŒä¸éª‘æ‰‹ç«¯ç›¸åŒäº¤äº’é€»è¾‘ -->
                <li><a href="#" class="nav-link" data-type="dishes">ğŸ” èœå“ç®¡ç†</a></li>
                <li><a href="#" class="nav-link" data-type="orders">ğŸ“¦ è®¢å•ç®¡ç†</a></li>
                <li><a href="#" class="nav-link" data-type="settings">âš™ï¸ åº—é“ºè®¾ç½®</a></li>
            </ul>
        </nav>

        <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆç»“æ„ä¸éª‘æ‰‹ç«¯ä¸€è‡´ï¼‰ -->
        <header class="top-nav">
            <nav class="user-menu">
                <span class="welcome-btn">ğŸ‘‹ æ¬¢è¿æ‚¨ï¼Œ{{ merchant_name }}</span>
                <a href="/logout/" class="welcome-btn">ğŸšª é€€å‡ºç™»å½•</a>
            </nav>
        </header>

        <!-- ä¸»å†…å®¹åŒºåŸŸï¼ˆæŒ‰åŠŸèƒ½åˆ†åŒºï¼‰ -->
        <main class="main-content">
            <!-- èœå“ç®¡ç†åŒºåŸŸ -->
            <section id="dishes" style="display: none;">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2>èœå“ç®¡ç†</h2>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="æœç´¢èœå“åç§°..." id="dish-search">
                    <button class="user-btn search-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        æœç´¢
                    </button>
                </div>
                </div>

                <!-- åœ¨èœå“è¡¨å•ä¸‹æ–¹æ·»åŠ åˆ†ç±»è¿‡æ»¤ -->
                <div class="filter-group">
                    <button class="filter-btn active" data-category="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-category="ä¸»é£Ÿ">ä¸»é£Ÿ</button>
                    <button class="filter-btn" data-category="é¥®æ–™">é¥®æ–™</button>
                    <button class="filter-btn" data-category="å°åƒ">å°åƒ</button>
                </div>

                <!-- ä¿®æ”¹èœå“ç®¡ç†åŒºåŸŸçš„è¡¨å•éƒ¨åˆ† -->
                <div class="dish-form">
                    <h3>æ–°å¢èœå“</h3>
                    <div class="form-group">
                        <input type="text" id="dish-name" placeholder="èœå“åç§°" required>
                        <input type="number" id="dish-price" placeholder="ä»·æ ¼" min="0" step="0.01" required>
                        <select id="dish-category">
                            <option value="">é€‰æ‹©åˆ†ç±»</option>
                            <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
                            <option value="é¥®æ–™">é¥®æ–™</option>
                            <option value="å°åƒ">å°åƒ</option>
                        </select>
                        <button class="user-btn add-dish-btn">ä¸Šæ¶èœå“</button>
                        <div class="error-msg" id="dish-error" style="display: none"></div>
                    </div>
                </div>

                <div class="dish-card template" style="display:none;">
                    <div class="dish-info">
                        <h3 class="dish-name"></h3>
                        <p>ä»·æ ¼ï¼šÂ¥<span class="dish-price"></span></p>
                        <p>åˆ†ç±»ï¼š<span class="dish-category">æš‚æ— åˆ†ç±»</span></p>
                    </div>
                    <div class="dish-actions">
                        <button class="edit-btn user-btn">ä¿®æ”¹</button>
                        <button class="delete-btn user-btn danger">ä¸‹æ¶</button>
                    </div>
                </div>

                <!-- æ–°å¢ç¼–è¾‘è¡¨å•æ¨¡æ¿ -->
                <div class="edit-form-overlay" style="display: none;">
                    <div class="edit-form">
                        <h3>ä¿®æ”¹èœå“ä¿¡æ¯</h3>
                        <form id="edit-dish-form">
                            <div class="form-group">
                                <input type="text" id="edit-dish-name" required>
                                <input type="number" id="edit-dish-price" min="0" step="0.01" required>
                                <select id="edit-dish-category">
                                    <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
                                    <option value="é¥®æ–™">é¥®æ–™</option>
                                    <option value="å°åƒ">å°åƒ</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="user-btn cancel-edit">å–æ¶ˆ</button>
                                <button type="submit" class="user-btn confirm-edit">ä¿å­˜ä¿®æ”¹</button>
                            </div>
                        </form>
                    </div>
                </div>


                <div class="dish-list"></div>
            </section>

            <!-- è®¢å•ç®¡ç†åŒºåŸŸï¼ˆç»“æ„ä¸éª‘æ‰‹ç«¯è®¢å•åˆ—è¡¨ç›¸ä¼¼ï¼‰ -->
            <section id="orders" style="display: none;">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>è¿›è¡Œä¸­è®¢å•ï¼ˆ<span id="active-count">0</span>ï¼‰</h2>
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="æœç´¢è®¢å•å·..." id="order-search">
                        <button class="user-btn search-btn">æœç´¢</button>
                    </div>
                </div>

                <div class="order-list" id="active-orders-list">
                    <!-- æ¨¡æ¿å†…å®¹ -->
                    <div class="order-card template" style="display:none;">
                        <!-- æ¨¡æ¿å†…å®¹ -->
                        <div class="order-status">
                            <span class="status-indicator status-pending"></span>
                            <span class="status-text">å¾…æ¥å•</span>
                        </div>
                        <h3 class="order-id">è®¢å•å·ï¼š<span class="value"></span></h3>
                        <p>å•†å®¶åœ°å€ï¼š<span class="merchant-address value"></span></p>
                        <p>å®¢æˆ·åœ°å€ï¼š<span class="customer-address value"></span></p>
                        <p>ä¸‹å•æ—¶é—´ï¼š<span class="order-time value"></span></p>
                        <div class="action-buttons">
                            <button class="accept-btn user-btn">æ¥å•</button>
                            <button class="detail-btn user-btn">è¯¦æƒ…</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- åº—é“ºè®¾ç½®åŒºåŸŸ -->
            <section id="settings" style="display: none;">
                <h2>åº—é“ºè®¾ç½®</h2>
                <div class="settings-form">
                    <form id="merchant-settings-form">
                        <div class="form-group">
                            <label>åº—é“ºåç§°:  </label>
                            <input type="text" id="merchant-name" required>
                        </div>
                        <div class="form-group">
                            <label>è”ç³»ç”µè¯</label>
                            <input type="tel" id="merchant-phone" required>
                        </div>
                        <div class="form-group">
                            <label>åº—é“ºåœ°å€</label>
                            <textarea id="merchant-address" rows="3" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="user-btn">ä¿å­˜è®¾ç½®</button>
                        </div>
                        <div class="error-msg" id="settings-error"></div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- åŠ è½½åŠ¨ç”»è’™å±‚ -->
    <div class="loading-mask">
        <div class="loading-spinner"></div>
    </div>

    <script>
    /* ===================== é¡µé¢ä¸»æ§åˆ¶å™¨ ===================== */
    document.addEventListener('DOMContentLoaded', () => {
        // ------------------ åˆå§‹åŒ–é˜¶æ®µ ------------------
        // åˆ›å»ºå¯¼èˆªç®¡ç†å®ä¾‹
        const navigationManager = new NavigationManager();

        // åˆ›å»ºåŠ è½½è’™å±‚
        const loadingMask = document.createElement('div');
        loadingMask.className = 'loading-mask';
        document.body.appendChild(loadingMask);

        // ------------------ äº‹ä»¶ç»‘å®šé˜¶æ®µ ------------------
        // èœå“ç®¡ç†ç›¸å…³äº‹ä»¶
        initDishManagement(navigationManager, loadingMask);

        // åº—é“ºè®¾ç½®ç›¸å…³äº‹ä»¶
        initSettingsManagement(loadingMask);

        // å…¬å…±UIäº‹ä»¶ï¼ˆä¾§è¾¹æ å“åº”å¼å¤„ç†ï¼‰
        initUIEvents();

        // æ–°å¢ç¼–è¾‘è¡¨å•åˆå§‹åŒ–
        initEditForm(navigationManager);

        // ------------------ æµè§ˆå™¨å†å²è®°å½•å¤„ç† ------------------
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.section) {
                navigationManager.switchSection(event.state.section);
            }
        });
    });

    /* ===================== å¯¼èˆªç®¡ç†ç±» ===================== */
    class NavigationManager {
        constructor() {
            this.currentSection = null;
            this.initNavigation();
            this.initDynamicElements();
        }

        /* --------------- åˆå§‹åŒ–æ–¹æ³• --------------- */
        initNavigation() {
            // ç»‘å®šå¯¼èˆªç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => this.handleNavClick(e));
            });

            // åˆå§‹åŒ–æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
            this.switchSection(this.getInitialSection());
        }

        initDynamicElements() {
            // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.menu-toggle');

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                document.body.classList.toggle('no-scroll');
            });

            // çª—å£å¤§å°å˜åŒ–ç›‘å¬
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                    document.body.classList.remove('no-scroll');
                }
            });
        }

        /* --------------- æ ¸å¿ƒåŠŸèƒ½æ–¹æ³• --------------- */
        // åŠ è½½èœå“æ•°æ®
        async loadDishes() {
            try {
                const response = await fetch('/api/dishes/', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                const dishes = await response.json();
                this.renderDishList(dishes);

            } catch (error) {
                this.showError('dishes', 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
                console.error('èœå“åŠ è½½å¤±è´¥:', error);
            }
        }

        // åŠ è½½åº—é“ºè®¾ç½®
        async loadSettings() {
            try {
                const response = await fetch('/api/merchant/settings/', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);

                const data = await response.json();
                this.populateSettingsForm(data);

            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                this.showError('settings', 'åŠ è½½è®¾ç½®å¤±è´¥');
            }
        }

        /* --------------- é¡µé¢æ¸²æŸ“æ–¹æ³• --------------- */
        // æ¸²æŸ“èœå“åˆ—è¡¨
        renderDishList(dishes) {
            const template = document.querySelector('#dishes .dish-card.template');
            const dishList = document.querySelector('#dishes .dish-list');
            dishList.innerHTML = '';

            dishes.forEach(dish => {
                const clone = this.createDishCard(dish, template);
                dishList.appendChild(clone);
            });
        }

        // åˆ›å»ºå•ä¸ªèœå“å¡ç‰‡
        createDishCard(dish, template) {
            const clone = template.cloneNode(true);
            clone.classList.remove('template');
            clone.style.display = 'flex';
            clone.dataset.dishId = dish.id;

            // å¡«å……æ•°æ®
            clone.querySelector('.dish-name').textContent = dish.name;
            clone.querySelector('.dish-price').textContent = Number(dish.price).toFixed(2);
            clone.querySelector('.dish-category').textContent = dish.category || 'æœªåˆ†ç±»';

            // ç»‘å®šäº‹ä»¶
            clone.querySelector('.edit-btn').addEventListener('click', () => this.showEditForm(dish));
            clone.querySelector('.delete-btn').addEventListener('click', () => this.handleDeleteDish(dish, clone));

            return clone;
        }

        /* --------------- äº‹ä»¶å¤„ç†æ–¹æ³• --------------- */
        // å¤„ç†å¯¼èˆªç‚¹å‡»
        handleNavClick(event) {
            event.preventDefault();
            const targetSection = event.target.dataset.type;
            this.switchSection(targetSection);
            this.updateURL(targetSection);
        }

        // å¤„ç†åˆ é™¤èœå“
        async handleDeleteDish(dish, element) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ ${dish.name}ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/api/dishes/${dish.id}/`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                response.ok ? element.remove() : alert('åˆ é™¤å¤±è´¥');
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
            }
        }

        /* --------------- è¾…åŠ©æ–¹æ³• --------------- */
        // åˆ‡æ¢åŠŸèƒ½æ¨¡å—
        switchSection(sectionId) {
            // éšè—æ‰€æœ‰æ¨¡å—
            document.querySelectorAll('section').forEach(section =>
                section.style.display = 'none'
            );

            // æ˜¾ç¤ºç›®æ ‡æ¨¡å—
            const target = document.getElementById(sectionId);
            if (target) {
                target.style.display = 'block';
                this.currentSection = sectionId;
                this.loadSectionData(sectionId);
            }

            // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
            this.updateNavActiveState(sectionId);
        }

        // æ›´æ–°æµè§ˆå™¨URL
        updateURL(sectionId) {
            const newUrl = `${window.location.pathname}?type=${sectionId}`;
            window.history.pushState({ section: sectionId }, '', newUrl);
        }

        // å¡«å……åº—é“ºè®¾ç½®è¡¨å•
        populateSettingsForm(data) {
            document.getElementById('merchant-name').value = data.name || '';
            document.getElementById('merchant-phone').value = data.phone || '';
            document.getElementById('merchant-address').value = data.address || '';
        }

        // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
        updateNavActiveState(sectionId) {
            document.querySelectorAll('.nav-link').forEach(link =>
                link.classList.toggle('active', link.dataset.type === sectionId)
            );
        }

        // åŠ è½½æ¨¡å—æ•°æ®
        async loadSectionData(sectionId) {
            switch (sectionId) {
                case 'dishes':
                    await this.loadDishes();
                    break;
                case 'orders':
                    await this.loadOrders();
                    break;
                case 'settings':
                    await this.loadSettings();
                    break;
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
        showEditForm(dish) {
            const overlay = document.querySelector('.edit-form-overlay');
            const form = document.getElementById('edit-dish-form');

            // å¡«å……å½“å‰æ•°æ®
            document.getElementById('edit-dish-name').value = dish.name;
            document.getElementById('edit-dish-price').value = dish.price;
            document.getElementById('edit-dish-category').value = dish.category || '';

            // æ˜¾ç¤ºè¡¨å•å¹¶ä¿å­˜ID
            overlay.style.display = 'flex';
            form.dataset.dishId = dish.id;
        }

        // è®¢å•åŠ è½½æ–¹æ³•ï¼ˆç¤ºä¾‹ï¼‰
        async loadOrders() {
            try {
                const response = await fetch('/api/orders/', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                const orders = await response.json();
                // è¿™é‡Œå¯ä»¥æ·»åŠ è®¢å•æ¸²æŸ“é€»è¾‘
                console.log('è®¢å•æ•°æ®:', orders);

            } catch (error) {
                console.error('è®¢å•åŠ è½½å¤±è´¥:', error);
                this.showError('orders', 'åŠ è½½è®¢å•å¤±è´¥');
            }
        }

        // è·å–åˆå§‹æ˜¾ç¤ºæ¨¡å—
        getInitialSection() {
            const params = new URLSearchParams(window.location.search);
            return params.get('type') || 'dishes';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆåŸç¼ºå¤±ï¼‰
        showError(sectionId, message) {
            const errorElement = document.querySelector(`#${sectionId} .error-msg`);
            if (errorElement) {
                errorElement.textContent = message;
                setTimeout(() => errorElement.textContent = '', 3000);
            }
        }

        // ä¿å­˜èœå“ä¿®æ”¹ï¼ˆåŸåœ¨æ³¨é‡Šä¸­ï¼‰
        async saveDishChanges(dishId, newData) {
            try {
                const response = await fetch(`/api/dishes/${dishId}/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(newData)
                });

                {#// æ·»åŠ çŠ¶æ€ç å’Œå“åº”å†…å®¹æ—¥å¿—#}
                {#console.log('HTTPçŠ¶æ€ç :', response.status);#}
                {#const responseText = await response.text();#}
                {#console.log('å“åº”å†…å®¹:', responseText);#}

                if (!response.ok) {
                    const error = responseText ? JSON.parse(responseText) : {};
                    throw new Error(error.message || 'ä¿å­˜å¤±è´¥');
                }

                await this.loadDishes();
                return true;

            } catch (error) {
                //console.error('å®Œæ•´é”™è¯¯ä¿¡æ¯:', error);
                alert(error.message);
                return false;
            }
        }
    }

    /* ===================== åŠŸèƒ½æ¨¡å—åˆå§‹åŒ– ===================== */
    // åˆå§‹åŒ–èœå“ç®¡ç†åŠŸèƒ½
    function initDishManagement(navManager, loadingMask) {
        const addBtn = document.querySelector('.add-dish-btn');

        addBtn.addEventListener('click', async (e) => {
            e.preventDefault(); // æ–°å¢è¿™è¡Œé˜»æ­¢é»˜è®¤è¡Œä¸º
            const nameInput = document.getElementById('dish-name');
            const priceInput = document.getElementById('dish-price');
            const categorySelect = document.getElementById('dish-category');
            const errorDiv = document.getElementById('dish-error');
            errorDiv.textContent = '';

            // å‰ç«¯éªŒè¯
            if (!validateDishForm(nameInput, priceInput, categorySelect, errorDiv)) return;

            loadingMask.style.display = 'block';

            try {
                console.log('å‘é€èœå“åˆ›å»ºè¯·æ±‚', {
                    name: nameInput.value.trim(),
                    price: parseFloat(priceInput.value),
                    category: categorySelect.value
                });
                const response = await fetch('/api/dishes/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: nameInput.value.trim(),
                        price: parseFloat(priceInput.value),
                        category: categorySelect.value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resetDishForm(nameInput, priceInput, categorySelect);
                    await navManager.loadDishes();
                } else {
                    errorDiv.textContent = data.error || 'ä¿å­˜å¤±è´¥';
                }
            } catch (error) {
                console.error('æ·»åŠ èœå“é”™è¯¯:', error); // æ–°å¢é”™è¯¯æ—¥å¿—
                errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
            } finally {
                loadingMask.style.display = 'none';
            }
        });
    }

    // åˆå§‹åŒ–åº—é“ºè®¾ç½®åŠŸèƒ½
    function initSettingsManagement(loadingMask) {
        const settingForm = document.getElementById('merchant-settings-form');

        settingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingMask.style.display = 'block';

            const formData = {
                name: document.getElementById('merchant-name').value.trim(),
                phone: document.getElementById('merchant-phone').value.trim(),
                address: document.getElementById('merchant-address').value.trim()
            };

            const errorDiv = document.getElementById('settings-error');
            errorDiv.textContent = '';

            if (!validateSettingsForm(formData, errorDiv)) return;

            try {
                const response = await fetch('/api/merchant/settings/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('è®¾ç½®å·²ä¿å­˜');
                    updateWelcomeMessage(formData.name);
                } else {
                    errorDiv.textContent = data.error || 'ä¿å­˜å¤±è´¥';
                }
            } catch (error) {
                errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
            } finally {
                loadingMask.style.display = 'none';
            }
        });
    }

    // ç‹¬ç«‹åˆå§‹åŒ–ç¼–è¾‘è¡¨å•
    function initEditForm(navManager) {
        const editForm = document.getElementById('edit-dish-form');
        const overlay = document.querySelector('.edit-form-overlay');

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dishId = editForm.dataset.dishId;
            const newData = {
                name: document.getElementById('edit-dish-name').value.trim(),
                price: parseFloat(document.getElementById('edit-dish-price').value),
                category: document.getElementById('edit-dish-category').value
            };

            if (await navManager.saveDishChanges(dishId, newData)) {
                overlay.style.display = 'none';
            }
        });
    }

    /* ===================== å·¥å…·å‡½æ•° ===================== */
    // æ–°å¢åº—é“ºè®¾ç½®è¡¨å•éªŒè¯
    // å¢å¼ºéªŒè¯å‡½æ•°ï¼ˆå¤„ç†å¤šä¸ªé”™è¯¯ï¼‰
    function validateSettingsForm(formData, errorDiv) {
        const errors = [];

        if (!formData.name) errors.push('åº—é“ºåç§°ä¸èƒ½ä¸ºç©º');
        if (!formData.phone) errors.push('æ‰‹æœºå·ç ä¸èƒ½ä¸ºç©º');
        if (!formData.address) errors.push('åº—é“ºåœ°å€ä¸èƒ½ä¸ºç©º');

        if (errors.length > 0) {
            errorDiv.textContent = errors.join('ï¼Œ');
            return false;
        }
        return true;
    }


    // éªŒè¯èœå“è¡¨å•
    function validateDishForm(nameInput, priceInput, categorySelect, errorDiv) {
        if (!nameInput.value.trim()) {
            errorDiv.textContent = 'è¯·è¾“å…¥èœå“åç§°';
            return false;
        }
        if (isNaN(priceInput.value) || priceInput.value <= 0) {
            errorDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆä»·æ ¼';
            return false;
        }
        if (!categorySelect.value) { // æ–°å¢åˆ†ç±»éªŒè¯
            errorDiv.textContent = 'è¯·é€‰æ‹©èœå“åˆ†ç±»';
            return false;
        }
        return true;
    }

    // é‡ç½®èœå“è¡¨å•
    function resetDishForm(nameInput, priceInput, categorySelect) {
        nameInput.value = '';
        priceInput.value = '';
        categorySelect.value = '';
    }

    // æ›´æ–°æ¬¢è¿ä¿¡æ¯
    function updateWelcomeMessage(name) {
        document.querySelector('.user-btn:first-child').textContent = `æ¬¢è¿æ‚¨ï¼Œ${name}`;
    }

    // åˆå§‹åŒ–UIäº‹ä»¶
    function initUIEvents() {
        const overlay = document.querySelector('.edit-form-overlay');

        // å–æ¶ˆç¼–è¾‘æŒ‰é’®
        document.querySelector('.cancel-edit').addEventListener('click', () => {
            overlay.style.display = 'none';
        });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.style.display = 'none';
        });
    }
    </script>

</body>
</html>